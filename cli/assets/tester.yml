---
version: 1
description: Terraform v12 rules
type: Terraform12
files:
  - "*.tf"
  - "*.tfvars"
rules:
  #     resources:
  #       - aws_db_instance
  #       - aws_dynamodb_table
  #       - aws_ebs_volume
  #       - aws_efs_file_system
  #       - aws_elasticsearch_domain
  #       - aws_emr_cluste
  #       - aws_kinesis_stream
  #       - aws_rds_cluster
  #       - aws_redshift_cluster
  #       - aws_s3_bucket
  #       - aws_sqs_queue
  #     category: resource

  - id: "[INFRA004] DATA_CLASS_TAG_VALID"
    message: "all data sources must have the data_class tag present. see the AWS required tagging standard here: xxxx"
    resource: aws_db_instance
    severity: FAILURE
    assertions:
      - or:
          - key: tags[0].data_class
            op: in
            value: public,internal,confidential
          - key: tags.data_class
            op: in
            value: public,internal,confidential
          # Fuzzy matching for nested modules that cant be resolved
          - key: tags
            op: contains
            value: tags
          - key: tags
            op: contains
            value: TAGS

            #     assertions:
            #       - and:
            #         # Must exist
            #         - key: tags.data_class
            #           op: present
            #         # And must be valid
            #         - every:
            #             key: tags[]
            #             expression:
            #               key: data_class
            #               op: in
            #               value: public,internal,confidential
